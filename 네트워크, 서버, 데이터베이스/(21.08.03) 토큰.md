# 토큰

## 토큰기반 인증 (Token-based Authentication)

### 1. 토큰기반 인증이란
- DB에 유저 정보를 담는 세션 기반 인증과는 달리 클라이언트에 정보 저장
- 토큰은 유저 정보를 암호화한 상태로 담을 수 있고, 암호화했기 때문에 클라이언트에 담아도 안전
- JWT (JSON Web Token) : 토큰기반 인증의 대표

### 2. JWT의 종류
- Access Token
  - 보호된 정보들(유저의 이메일, 연락처, 사진 등)에 접근할 수 있는 권한부여에 사용

  - 로그인시 Access Token과 Refresh Token을 모두 받지만, 실제로 권한을 받는데 사용하는 토큰은 Access Token

  - 탈취 리스크를 방지하지 위해 access token은 비교적 짧은 유효기간을 가지며 만료 시 새로운 access token을 발급 (재로그인은 불필요)

- Refresh Token
  - 유효기간이 길어 탈취당하면 문제가 됨

  - 편의보다 보안이 중요한 웹사이트는 refresh token을 사용하지 않는 곳이 많음

### 3. JWT 구조
- Header : token 종류와 암호화할 알고리즘을 JSON 형태로 기재
```js
{
  "alg": "HS256",
  "typ": "JWT"
}
```

- Payload : 정보 접근 권한과 유저 데이터 등 정보가 담겨 있으며 민감 정보는 담지 않는 것이 좋음
```js
{
  "sub": "someInformation",
  "name": "phillip",
  "iat": 151623391
}
```

- Signature : 원하는 비밀 키롤 사용하여 암호화
```js
// HMAC SHA256 알고리즘 사용

HMACSHA256(base64UrlEncode(header) + '.' + base64UrlEncode(payload), secret);
```

- 사용 예시 : A 앱이 Gmail과 연동되서 이메일을 읽을 경우
  - Gmail 인증서버에 로그인정보(아이디, 비밀번호)를 제공한다

  - 성공적으로 인증시 JWT 를 발급받는다

  - A앱은 JWT를 사용해 해당 유저의 Gmail 이메일을 읽거나 사용할 수 있다

### 4. 토큰기반 인증 절차 예시

- 클라이언트가 서버에 아이디/비밀번호를 담아 로그인 요청을 보냄
- 아이디/비밀번호가 일치하는지 확인하고, 클라이언트에게 보낼 암호화된 토큰을 생성 (access/refresh 토큰을 모두 생성)
  - 토큰에 담길 정보(payload)는 유저를 식별할 정보, 권한이 부여된 카테고리(사진, 연락처, 기타등등)이 될 수 있음
  - 두 종류의 토큰이 같은 정보를 담을 필요는 없음
- 토큰을 클라이언트에게 보내주면, 클라이언트는 토큰을 저장 (저장 위치는 local storage, cookie, react의 state 등 다양)
- 클라이언트가 HTTP 헤더(authorization 헤더)에 토큰을 담아 보냄 (bearer authentication을 이용 가능)
- 서버는 토큰을 해독하여 "아 우리가 발급해준 토큰이 맞네!" 라는 판단이 될 경우, 클라이언트의 요청을 처리한 후 응답을 보내줌

### 5. 토큰기반 인증 장점
- Statelessness & Scalability (무상태성 & 확장성)
  - 서버는 클라이언트에 대한 정보를 저장할 필요 없음 (토큰 해독이 되는지만 판단)
  - 클라이언트는 새로운 요청을 보낼때마다 토큰을 헤더에 포함시키면 됨
  - 서버를 여러개 가지고 있는 서비스라면 더더욱 빛을 발휘 (같은 토큰으로 여러 서버에서 인증 가능)

- 안전함 : 암호화 한 토큰을 사용하고, 암호화 키를 노출 할 필요가 없기 때문에 안전함

- 어디서나 생성 가능
  - 토큰을 확인하는 서버가 토큰을 만들지 않아도 됨
  - 토큰 생성용 서버를 만들거나, 다른 회사에서 토큰관련 작업을 맡기는 것 등 다양한 활용이 가능

- 권한 부여에 용이
  - 토큰의 payload(내용물) 안에 어떤 정보에 접근 가능한지 정할 수 있음 (예시 : 서비스의 사진과 연락처 사용권한만 부여)
