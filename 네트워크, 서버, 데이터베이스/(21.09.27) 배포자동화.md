# 배포자동화

***

## CI/CD (지속적 통합/지속적 배포)
- CI/CD 자동화는 DevOps 엔지니어의 핵심 업무
- DevOps에서 배포 이후 운영까지 관리

### 1. CI (Continuous Integration)
- 새로운 코드 변경 사항이 정기적으로 빌드 및 테스트 되어 공유 레포지토리에 통합히는 것을 의미

### 2. CD
- Continuous Delivery & Continuous Deployment 의 축약어
- 개발자의 변경 사항이 레포지토리를 넘어, 고객의 프로덕션(Production) 환경까지 릴리즈 되는 것

### 3. CI/CD 프로세스

<img width="850" alt="스크린샷 2021-09-27 오후 9 45 30" src="https://user-images.githubusercontent.com/80403988/134913335-89cf8cc1-59b3-41b8-a052-79d89d8ca579.png">

- release : version tagging (1.0, 2.0...) 등 업데이트 변경사항 적어주기

***

## 배포 과정에서 사용되는 서비스

### 1. CodePipeline (AWS)
- CodePipeline (AWS) : Code, Build, Deploy 3단계를 프로세스로 만들어줌
- 각각 GITHUB, CodeBuild(AWS), CodeDeploy(AWS) 사용

### 2. CodeCommit (AWS)
- 코드를 입력하는 Source 단계를 구성할 때 이용하며, GITHUB와 유사
- GITHUB 보다 보안은 뛰어나지만, 과금 우려

### 3. CodeBuild (AWS)
- Build 단계에서 사용되며, 작업 명령어를 통해서 실행됨
- 실습에서 서버쪽은 Build가 필요없어서 클라이언트 쪽인 S3에서만 CodeBuild 이용

### 4. CodeDeploy (AWS)
- 실행되고 있는 서버 애플리케이션에 실시간으로 변경 사항을 전달
- 실습에서 서버는 애플리케이션이 실행되는 상태로 유지되어야 함으로 CodeDeploy 이용

***

## 클라이언트 배포 과정 (실습)
- 코드 - 빌드 - 배포 후 결과물을 S3에 넣음

### 1. CodeBuild Phase (buildspec.yml 파일 생성)
- install : dependency, 런타임(node.js 등) 설치
- pre_build : 종속성 설치 및 테스트 진행
- build : 실질적인 빌드 진행
- post_build : 빌드 후 추가적인 작업이 필요한 경우 진행

```yml
version: 0.2

phases:
  pre_build:
    commands:
      - cd client
      - npm install
  build:
    commands:
      - npm run build

artifacts:
  files:
    - '**/*'
  base-directory: client/build
```

### 2. Pipeline 구성 (CodePipeline 사용)
- Code : 코드를 GITHUB 에 업로드 하고, GITHUB를 AWS CodePipeline과 연동하기

- Build : 빌드 단계에서 CodeBuild 프로젝트 생성

- Deploy : S3와 연결하기

- 로그 확인 : CodeBuild 콘솔의 프로젝트 빌드 메뉴, cloudWatch 사용

***

## 서버 배포 과정 (실습)

### 1. 인스턴스 태그와 역할 부여
- 인스턴스의 태그의 키와 값 설정하기
- 보안 IAM 서비스로 EC2 인스턴스의 역할 부여
- 보안 그룹의 인바운드 규칙 설정

### 2. appspec.yml 파일 등 추가하기
- 최상의 폴더에 appspec.yml 파일을 추가

- 애플리케이션 중단 및 실행과 관련된 코드 및 수명 주기에 필요한 명령도 설정

```yml
version: 0.0
os: linux
files:
  - source: /
    destination: /home/ubuntu/im-sprint-practice-deploy

hooks:
  ApplicationStop:
    - location: scripts/stop.sh
      runas: root
  AfterInstall:
    - location: scripts/initialize.sh
      runas: root
  ApplicationStart:
    - location: scripts/start.sh
      runas: root
```

- scripts 폴더를 생성하고 shellscript 파일들 추가

  - scripts/initialize.sh
  ```sh
  #!/bin/bash
  cd /home/ubuntu/im-sprint-practice-deploy/server
  npm install
  npm install pm2@latest -g
  sudo apt-get update
  sudo apt-get install authbind
  sudo touch /etc/authbind/byport/80
  sudo chown ubuntu /etc/authbind/byport/80
  sudo chmod 755 /etc/authbind/byport/80
  ```

  - scripts/start.sh
  ```sh
  #!/bin/bash
  cd /home/ubuntu/im-sprint-practice-deploy/server
  authbind --deep pm2 start app.js
  ```

  - scripts/stop.sh
  ```sh
  #!/bin/bash
  cd /home/ubuntu/im-sprint-practice-deploy/server
  pm2 stop app.js 2> /dev/null || true
  pm2 delete app.js 2> /dev/null || true
  ```

- shellscript(sh)란?

  - chmod +x ./initialize.sh (x는 실행권한) 이 먼저 됨

  - ./initialize.sh 하면 실행됨

### 3. CodeDeploy 사용
- 애플리케이션을 통해 EC2 배포 진행
- 위에서 만든 역할과 태그 연동하기

### 4. Pipeline 구성 (CodePipeline 사용)
- Code : 코드를 GITHUB 에 업로드 하고, GITHUB를 AWS CodePipeline과 연동하기
- Build : 빌드 스테이지 건너뛰기
- Deploy : 배포공급자, 애플리케이션, 배포 그룹 연결하기

### 5. TypeScript로 작성했다면?
- 추가로 빌드 작업이 필요
- Node.js 런타임으로는 TypeScyprt 언어로 서버 실행이 어렵기 때문
